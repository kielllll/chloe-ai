services:
  # Main NestJS API Service
  - type: web
    name: chloe-ai-api
    env: node
    plan: free
    buildCommand: pnpm install --frozen-lockfile --ignore-scripts && pnpm rebuild sharp && pnpm run build
    startCommand: pnpm run start:prod

    # Environment variables (to be configured in Render dashboard)
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000 # Render's free tier port
      - key: SHARP_IGNORE_GLOBAL_LIBVIPS
        value: '1'
      - key: npm_config_sharp_binary_host
        value: 'https://npmmirror.com/mirrors/sharp'

    # Free tier constraints
    healthCheckPath: /health
    autoDeploy: yes

    # Build cache optimization
    buildFilter:
      paths:
        - package.json
        - pnpm-lock.yaml
        - src/**

# Add-ons for external services
databases:
  # Render's PostgreSQL (free tier) - optional backup
  - name: chloe-ai-db
    databaseName: chloe_ai
    plan: free
